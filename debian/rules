#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all

DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
DEB_UPSTREAM_VERSION = $(shell dpkg-parsechangelog -S version | cut -d - -f 1 | cut -d : -f 2)
# We don't need a Build-Depends on systemd because of this
# because it's only used to decide whether the tests should be run or not.
# Any value other than "lxc" will let the tests run.
VIRT = $(shell systemd-detect-virt 2>/dev/null)
ifeq (,$(VIRT))
VIRT = unknown
endif

%:
	dh $@ --with bash-completion

override_dh_auto_build:
	+$(MAKE) doc
	dh_auto_build  -- prefix=/usr libdir=/usr/lib/$(DEB_HOST_MULTIARCH) sysconfdir=/etc bashcompdir=/usr/share/bash-completion/completions NORPATH=1

override_dh_auto_install:
	dh_auto_install -- prefix=/usr libdir=/usr/lib/$(DEB_HOST_MULTIARCH) sysconfdir=/etc bashcompdir=/usr/share/bash-completion/completions NORPATH=1

override_dh_install:
	echo =======================
	find
	echo =======================
	mkdir -p debian/tmp/usr/share/pmdk/
	cp utils/pmdk.magic debian/tmp/usr/share/pmdk/
	dh_install

override_dh_installexamples:
	dh_installexamples --exclude=.gitignore

override_dh_auto_test:
ifeq ($(VIRT),lxc)
	# these tests do not yet work in a lxd container, see
	# https://bugs.launchpad.net/ubuntu/+bug/1752378/comments/73
	@echo "$(VIRT) environment detected, skipping unit tests"
else
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	# Use fake pmem; we really want tmpfs if possible.
	# No non-pmem dir, as real syncs there are slow.
	echo "PMEM_FS_DIR=/tmp" > src/test/testconfig.sh
	# Use cache flushes instead of msync().
	echo "PMEM_FS_DIR_FORCE_PMEM=1" >> src/test/testconfig.sh
	# Don't try static libs.
	echo "TEST_BUILD=\"debug nondebug\"" >> src/test/testconfig.sh
	# Display execution time of each test
	echo "TM=1" >> src/test/testconfig.sh
	+$(MAKE) check
endif
endif
